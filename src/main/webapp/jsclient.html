<!DOCTYPE html>
<!--
  ~ Copyright 2016 Olov McKie
  ~ Copyright 2016 Uppsala University Library
  ~
  ~ This file is part of Cora.
  ~
  ~     Cora is free software: you can redistribute it and/or modify
  ~     it under the terms of the GNU General Public License as published by
  ~     the Free Software Foundation, either version 3 of the License, or
  ~     (at your option) any later version.
  ~
  ~     Cora is distributed in the hope that it will be useful,
  ~     but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~     GNU General Public License for more details.
  ~
  ~     You should have received a copy of the GNU General Public License
  ~     along with Cora.  If not, see <http://www.gnu.org/licenses/>.
  -->

<html>
<head>
<meta charset="UTF-8"></meta>
<title>JSClient</title>
<link rel="stylesheet" type="text/css" href="css/presentation.css"></link>
<link rel="stylesheet" type="text/css" href="css/jsClient.css"></link>

<script type="text/javascript" src="script/aCoraNameSpace.js"></script>

<script type="text/javascript" src="script/lib/arbiter.js"></script>
<script type="text/javascript" src="script/lib/polyfillES6.js"></script>

<script type="text/javascript" src="script/ajaxCall.js"></script>
<script type="text/javascript" src="script/coraData.js"></script>
<script type="text/javascript" src="script/coraPubSub.js"></script>
<script type="text/javascript" src="script/dataHolder.js"></script>
<script type="text/javascript" src="script/jsBookkeeper.js"></script>
<script type="text/javascript" src="script/jsClient.js"></script>
<script type="text/javascript" src="script/metadataChildInitializer.js"></script>
<script type="text/javascript" src="script/metadataController.js"></script>
<script type="text/javascript" src="script/metadataRepeatInitializer.js"></script>
<script type="text/javascript" src="script/pChildRefHandler.js"></script>
<script type="text/javascript" src="script/pChildRefHandlerView.js"></script>
<script type="text/javascript" src="script/pGroup.js"></script>
<script type="text/javascript" src="script/pMultipleChildren.js"></script>
<script type="text/javascript" src="script/pRepeatingContainer.js"></script>
<script type="text/javascript" src="script/pRepeatingElement.js"></script>
<script type="text/javascript" src="script/pSurroundingContainer.js"></script>
<script type="text/javascript" src="script/presentation.js"></script>
<script type="text/javascript" src="script/presentationFactory.js"></script>
<script type="text/javascript" src="script/pVar.js"></script>
<script type="text/javascript" src="script/textProvider.js"></script>
<script type="text/javascript" src="script/xmlHttpRequestFactory.js"></script>

<script type="text/javascript"
	src="../../test/script/metadataProviderStub.js"></script>
<script type="text/javascript" src="test/script/metadataProviderStub.js"></script>
<script type="text/javascript"
	src="../../test/script/textProviderStub.js"></script>
<script type="text/javascript" src="test/script/textProviderStub.js"></script>
<script type="text/javascript"
	src="../../test/script/metadataProviderRealStub.js"></script>
<script type="text/javascript"
	src="test/script/metadataProviderRealStub.js"></script>
<script type="text/javascript"
	src="../../test/script/textProviderRealStub.js"></script>
<script type="text/javascript" src="test/script/textProviderRealStub.js"></script>

<script type="text/javascript">
	var CORATEST = (function(coraTest) {
		"use strict";
		coraTest.dependenciesFactory = function(metadataProvider, pubSub, textProvider) {
			var factor = function(metadataId, presentationId, data) {
				var specDataHolder = {
					"metadataId" : metadataId,
					"metadataProvider" : metadataProvider,
					"pubSub" : pubSub
				};
				var dataHolder = CORA.dataHolder(specDataHolder);

				var specJSBookkeeper = {
					"metadataId" : metadataId,
					"metadataProvider" : metadataProvider,
					"pubSub" : pubSub,
					"textProvider" : textProvider,
					"dataHolder" : dataHolder
				};
				var jsBookkeeper = CORA.jsBookkeeper(specJSBookkeeper);

				var specPresentationFactory = {
					"metadataProvider" : metadataProvider,
					"pubSub" : pubSub,
					"textProvider" : textProvider,
					"jsBookkeeper" : jsBookkeeper
				};
				var presentationFactory = CORA.presentationFactory(specPresentationFactory);

				var spec = {
					"presentationId" : presentationId,
					"metadataProvider" : metadataProvider,
					"pubSub" : pubSub,
					"textProvider" : textProvider,
					"jsBookkeeper" : jsBookkeeper,
					"presentationFactory" : presentationFactory
				};
				var presentation = CORA.presentation(spec);
				var presentation2 = CORA.presentation(spec);

				// // log all messages
				//			pubSub.subscribe("*", {}, undefined, function(dataFromMsg, msg) {
				//				console.log("msg: " + msg);
				//				console.log("dataFromMsg: " + JSON.stringify(dataFromMsg));
				//			});
				var specMetadataController = {
					"metadataId" : metadataId,
					"data" : data,
					"metadataProvider" : metadataProvider,
					"pubSub" : pubSub
				};
				var metadataController = CORA.metadataController(specMetadataController);

				return Object.freeze({
					jsBookkeeper : jsBookkeeper,
					presentationFactory : presentationFactory,
					presentation : presentation,
					presentation2 : presentation2,
					dataHolder : dataHolder,
					metadataController : metadataController
				});
			};
			return Object.freeze({
				factor : factor
			});
		};

		return coraTest;
	}(CORATEST || {}));

	window.onload = start;
	function start() {
		startJsClient();
		getStuffFromServer();

		var metadataProvider = new MetadataProviderStub();
		var textProvider = CORATEST.textProviderStub();
		client1(metadataProvider, textProvider);
		client2(metadataProvider, textProvider);
		client3(metadataProvider, textProvider);
		client4(metadataProvider, textProvider);
		client5(metadataProvider, textProvider);
		client6(metadataProvider, textProvider);
		client7(metadataProvider, textProvider);
		client8(metadataProvider, textProvider);

		var metadataProviderRealStub = CORATEST.metadataProviderRealStub();
		var textProviderRealStub = CORATEST.textProviderRealStub();
		client9(metadataProviderRealStub, textProviderRealStub);

	}

	function startJsClient() {
		var spec = {
			"xmlHttpRequestFactory" : CORA.xmlHttpRequestFactory(),
			"name" : "The Client",
			"baseUrl" : "http://epc.ub.uu.se/cora/rest/"
		};
		var jsClient = CORA.jsClient(spec);
		document.body.appendChild(jsClient.getView());
	}

	function getStuffFromServer() {
		var spec = {
			"xmlHttpRequestFactory" : CORA.xmlHttpRequestFactory(),
			"timeoutInMS" : 1000,
			"timeoutMethod" : function() {
				alert("timeout");
			},
			"method" : "GET",
			"url" : "http://epc.ub.uu.se/cora/rest/record/recordType/textSystemOne",
			"contentType" : "application/uub+record+json",
			"accept" : "application/uub+record+json",
			"loadMethod" : loadMethod,
			"errorMethod" : function(error) {
				alert("error" + error.status);
			},
		};
		CORA.ajaxCall(spec);
	}
	function loadMethod(answer) {
		var xmlHttpRequest1 = document.getElementById("xmlHttpRequest1");
		xmlHttpRequest1.textContent = answer.responseText;
	}
	function client1(metadataProvider, textProvider) {
		var place = document.getElementById("client1");
		var pubSub = CORA.pubSub();
		var dependenciesFactory = CORATEST.dependenciesFactory(metadataProvider, pubSub,
				textProvider);
		var metadataId = "groupIdOneTextChild";
		var presentationId = "pgGroupIdOneTextChildOutput";

		// 		var data = {
		// 				"name" : "groupIdOneTextChild",
		// 				"children" : [ {
		// 					"name" : "textVariableId",
		// 					"value" : "A Value!"
		// 				} ]
		// 			};

		var dependencies = dependenciesFactory.factor(metadataId, presentationId);

		var view = dependencies.presentation.getView();
		place.appendChild(view);

		var path2 = {
			"name" : "linkedPath",
			"children" : [ {
				"name" : "nameInData",
				"value" : "textVariableId"
			} ]
		};
		var data2 = {
			"path" : path2,
			"data" : "a Value"
		};
		pubSub.publish("setValue", data2);
	}

	function client2(metadataProvider, textProvider) {
		var place = document.getElementById("client2");
		var pubSub = CORA.pubSub();
		var dependenciesFactory = CORATEST.dependenciesFactory(metadataProvider, pubSub,
				textProvider);
		var metadataId = "groupIdOneTextChild";
		var presentationId = "pgGroupIdOneTextTwoTextChildren";

		var data = {
			"name" : "groupIdOneTextChild",
			"children" : [ {
				"name" : "textVariableId",
				"value" : "A different value!"
			} ]
		};

		var dependencies = dependenciesFactory.factor(metadataId, presentationId, data);

		var view = dependencies.presentation.getView();
		place.appendChild(view);

		var path2 = {
			"name" : "linkedPath",
			"children" : [ {
				"name" : "nameInData",
				"value" : "textVariableId"
			} ]
		};
		var data2 = {
			"path" : path2,
			"data" : "aValue1"
		};

		// 		pubSub.publish("setValue", data2);
	}

	function client3(metadataProvider, textProvider) {
		var place = document.getElementById("client3");
		var pubSub = CORA.pubSub();
		var dependenciesFactory = CORATEST.dependenciesFactory(metadataProvider, pubSub,
				textProvider);
		var metadataId = "groupInGroupOneTextChild";
		var presentationId = "pgGroupInGroupIdOneTextOneTextChild";

		var data = {
			"name" : "groupInGroupOneTextChild",
			"children" : [ {
				"name" : "groupIdOneTextChild",
				"children" : [ {
					"name" : "textVariableId",
					"value" : "A Value2"
				} ]
			} ]
		};

		var dependencies = dependenciesFactory.factor(metadataId, presentationId, data);

		var view = dependencies.presentation.getView();
		place.appendChild(view);
	}

	function client4(metadataProvider, textProvider) {
		var place = document.getElementById("client4");
		var pubSub = CORA.pubSub();
		var dependenciesFactory = CORATEST.dependenciesFactory(metadataProvider, pubSub,
				textProvider);
		// 		var metadataId = "groupIdOneTextChild";
		// 		var presentationId = "pgGroupIdOneTextTwoTextChildrenRepeat1toX";
		var metadataId = "groupIdOneTextChildRepeat1to3";
		// 		var presentationId = "pgGroupIdOneTextTwoTextChildrenRepeat1to3";
		var presentationId = "pgGroupIdRepeatingContainerRepeat1to3";

		var data = {
			"name" : "groupIdOneTextChild",
			"children" : [ {
				"name" : "textVariableId",
				"value" : "A different value!",
				"repeatId" : "one"
			} ]
		};

		var dependencies = dependenciesFactory.factor(metadataId, presentationId, data);

		var view = dependencies.presentation.getView();
		place.appendChild(view);

		view.dataHolder = dependencies.dataHolder;

		function showData() {
			var clientData = document.getElementById("client4Data");
			clientData.innerHTML = JSON.stringify(dependencies.dataHolder.getData());
		}
		document.getElementById("client4DataButton").onclick = showData;

		var path2 = {
			"name" : "linkedPath",
			"children" : [ {
				"name" : "nameInData",
				"value" : "textVariableId"
			} ]
		};
		var data2 = {
			"path" : path2,
			"data" : "aValue1"
		};

		// 		pubSub.publish("setValue", data2);
	}
	function client5(metadataProvider, textProvider) {
		var place = document.getElementById("client5");
		var pubSub = CORA.pubSub();
		var dependenciesFactory = CORATEST.dependenciesFactory(metadataProvider, pubSub,
				textProvider);
		var metadataId = "groupIdTwoTextChildRepeat1to5";
		var presentationId = "pgGroupIdTwoTextChildSurrounding2TextPGroup2";

		var dependencies = dependenciesFactory.factor(metadataId, presentationId);

		var view = dependencies.presentation.getView();
		place.appendChild(view);

		view.dataHolder = dependencies.dataHolder;

		function showData() {
			var clientData = document.getElementById("client5Data");
			clientData.innerHTML = JSON.stringify(dependencies.dataHolder.getData());
		}
		document.getElementById("client5DataButton").onclick = showData;
	}
	function client6(metadataProvider, textProvider) {
		var place = document.getElementById("client6");
		var pubSub = CORA.pubSub();
		var dependenciesFactory = CORATEST.dependenciesFactory(metadataProvider, pubSub,
				textProvider);
		var metadataId = "textVarRepeat1to3InGroupOneAttributeAndOtherAttributeRepeat0to2InGroup";
		var presentationId = "pgTextVarRepeat1to3InGroupOneAttributeAndOtherAttributeRepeat0to2InGroup";

		var data = {
			"name" : "textVarRepeat1to3InGroupOneAttributeAndOtherAttributeRepeat0to2InGroup",
			"children" : [ {
				"name" : "textVarRepeat1to3InGroupOneAttribute",
				"children" : [ {
					"name" : "textVar",
					"value" : "one",
					"repeatId" : "1"
				}, {
					"name" : "textVar",
					"value" : "two",
					"repeatId" : "2"
				} ],
				"attributes" : {
					"anAttribute" : "aFinalValue"
				},
				"repeatId" : "1"
			}, {
				"name" : "textVarRepeat1to3InGroupOneAttribute",
				"children" : [ {
					"name" : "textVar",
					"value" : "three",
					"repeatId" : "3"
				} ],
				"attributes" : {
					"anAttribute" : "aFinalValue"
				},
				"repeatId" : "2"
			}, {
				"name" : "textVarRepeat1to3InGroupOneAttribute",
				"children" : [ {
					"name" : "textVar",
					"value" : "four",
					"repeatId" : "4"
				} ],
				"attributes" : {
					"anOtherAttribute" : "aOtherFinalValue"
				},
				"repeatId" : "3"
			} ]
		};
		var dependencies = dependenciesFactory.factor(metadataId, presentationId, data);

		var view = dependencies.presentation.getView();
		place.appendChild(view);

		view.dataHolder = dependencies.dataHolder;

		function showData() {
			var clientData = document.getElementById("client6Data");
			clientData.innerHTML = JSON.stringify(dependencies.dataHolder.getData());
		}
		document.getElementById("client6DataButton").onclick = showData;
	}
	function client7(metadataProvider, textProvider) {
		var place = document.getElementById("client7");
		var pubSub = CORA.pubSub();
		var dependenciesFactory = CORATEST.dependenciesFactory(metadataProvider, pubSub,
				textProvider);
		var metadataId = "groupIdOneTextChildRepeat1to3";
		var presentationId = "pgGroupIdOneTextChildMinimized";
		// 		var presentationId = "pgGroupIdRepeatingContainerRepeat1to3";

		// 		var data = {
		// 			"name" : "textVarRepeat1to3InGroupOneAttributeAndOtherAttributeRepeat0to2InGroup",
		// 			"children" : [ {
		// 				"name" : "textVarRepeat1to3InGroupOneAttribute",
		// 				"children" : [ {
		// 					"name" : "textVar",
		// 					"value" : "one",
		// 					"repeatId" : "1"
		// 				}, {
		// 					"name" : "textVar",
		// 					"value" : "two",
		// 					"repeatId" : "2"
		// 				} ],
		// 				"attributes" : {
		// 					"anAttribute" : "aFinalValue"
		// 				},
		// 				"repeatId" : "1"
		// 			}, {
		// 				"name" : "textVarRepeat1to3InGroupOneAttribute",
		// 				"children" : [ {
		// 					"name" : "textVar",
		// 					"value" : "three",
		// 					"repeatId" : "3"
		// 				} ],
		// 				"attributes" : {
		// 					"anAttribute" : "aFinalValue"
		// 				},
		// 				"repeatId" : "2"
		// 			}, {
		// 				"name" : "textVarRepeat1to3InGroupOneAttribute",
		// 				"children" : [ {
		// 					"name" : "textVar",
		// 					"value" : "four",
		// 					"repeatId" : "4"
		// 				} ],
		// 				"attributes" : {
		// 					"anOtherAttribute" : "aOtherFinalValue"
		// 				},
		// 				"repeatId" : "3"
		// 			} ]
		// 		};
		// 		var dependencies = dependenciesFactory.factor(metadataId, presentationId, data);
		var dependencies = dependenciesFactory.factor(metadataId, presentationId);

		var view = dependencies.presentation.getView();
		place.appendChild(view);

		view.dataHolder = dependencies.dataHolder;

		function showData() {
			var clientData = document.getElementById("client7Data");
			clientData.innerHTML = JSON.stringify(dependencies.dataHolder.getData());
		}
		document.getElementById("client7DataButton").onclick = showData;
	}
	function client8(metadataProvider, textProvider) {
		var place = document.getElementById("client8");
		var pubSub = CORA.pubSub();
		var dependenciesFactory = CORATEST.dependenciesFactory(metadataProvider, pubSub,
				textProvider);
		var metadataId = "groupId1toXCollectionChild";
		var presentationId = "pgGroupId1toXCollectionChild";

		var data = {
			"name" : "groupId1toXCollectionChild",
			"children" : [ {
				"name" : "yesNoUnknownVar",
				"value" : "",
				"repeatId" : "0"
			}, {
				"name" : "yesNoUnknownVar",
				"value" : "yes",
				"repeatId" : "1"
			}, {
				"name" : "yesNoUnknownVar",
				"value" : "no",
				"repeatId" : "2"
			}, {
				"name" : "yesNoUnknownVar",
				"value" : "unknown",
				"repeatId" : "3"
			} ]
		};
		var dependencies = dependenciesFactory.factor(metadataId, presentationId, data);

		var view = dependencies.presentation.getView();
		place.appendChild(view);

		view.dataHolder = dependencies.dataHolder;

		function showData() {
			var clientData = document.getElementById("client8Data");
			clientData.innerHTML = JSON.stringify(dependencies.dataHolder.getData());
		}
		document.getElementById("client8DataButton").onclick = showData;
		place.appendChild(dependencies.presentation2.getView());

	}

	function client9(metadataProvider, textProvider) {
		var place = document.getElementById("client9");
		var pubSub = CORA.pubSub();
		var dependenciesFactory = CORATEST.dependenciesFactory(metadataProvider, pubSub,
				textProvider);
		var metadataId = "textSystemOneNewGroup";
		var presentationId = "textSystemOneNewPGroup";
		var dependencies = dependenciesFactory.factor(metadataId, presentationId);

		var view = dependencies.presentation.getView();
		place.appendChild(view);

		view.dataHolder = dependencies.dataHolder;

		function showData() {
			var clientData = document.getElementById("client9Data");
			clientData.innerHTML = JSON.stringify(dependencies.dataHolder.getData());
		}
		document.getElementById("client9DataButton").onclick = showData;

		// 		var spec = {
		// 				"presentationId" : presentationId,
		// 				"metadataProvider" : metadataProvider,
		// 				"pubSub" : pubSub,
		// 				"textProvider" : textProvider,
		// 				"jsBookkeeper" : dependencies.jsBookkeeper,
		// 				"presentationFactory" : dependencies.presentationFactory
		// 			};
		// 			var presentation2 = CORA.presentation(spec);
		place.appendChild(dependencies.presentation2.getView());

	}
</script>
</head>
<body>
	<h1>XMLHttpRequest</h1>

	<h2>XMLHttpRequest 1</h2>
	<div id="xmlHttpRequest1" class="xmlHttpRequest1"
		style="min-height: 20px; min-width: 40px;"></div>

	<h1>JSClient</h1>

	<h2>JSClient 1</h2>
	<div id="client1" class="client1"
		style="min-height: 20px; min-width: 40px;"></div>

	<h2>JSClient 2</h2>
	<div id="client2" class="client2"
		style="min-height: 20px; min-width: 40px;"></div>

	<h2>JSClient 3(group in group)</h2>
	<div id="client3" class="client3"
		style="min-height: 20px; min-width: 40px;"></div>

	<h2>JSClient 4 (repeatingContainer)</h2>
	<div id="client4" class="client4"
		style="min-height: 20px; min-width: 40px;"></div>
	<div id="client4Data"></div>
	<input id="client4DataButton" type="button" value="Show data"></input>

	<h2>JSClient 5 (surroundingContainer)</h2>
	<div id="client5" class="client5"
		style="min-height: 20px; min-width: 40px;"></div>
	<div id="client5Data"></div>
	<input id="client5DataButton" type="button" value="Show data"></input>

	<h2>JSClient 6 (groups has same nameInData different attributes)</h2>
	<div id="client6" class="client6"
		style="min-height: 20px; min-width: 40px;"></div>
	<div id="client6Data"></div>
	<input id="client6DataButton" type="button" value="Show data"></input>

	<h2>JSClient 7 (minimized)</h2>
	<div id="client7" class="client7"
		style="min-height: 20px; min-width: 40px;"></div>
	<div id="client7Data"></div>
	<input id="client7DataButton" type="button" value="Show data"></input>

	<h2>JSClient 8 (select)</h2>
	<div id="client8" class="client8"
		style="min-height: 20px; min-width: 40px;"></div>
	<div id="client8Data"></div>
	<input id="client8DataButton" type="button" value="Show data"></input>

	<h2>JSClient 9 (text)</h2>
	<div id="client9" class="client9"
		style="min-height: 20px; min-width: 40px;"></div>
	<div id="client9Data"></div>
	<input id="client9DataButton" type="button" value="Show data"></input>

</body>
</html>

