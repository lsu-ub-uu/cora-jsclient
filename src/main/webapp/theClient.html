<!DOCTYPE html>
<!--
  ~ Copyright 2016, 2017 Olov McKie
  ~ Copyright 2016, 2017 Uppsala University Library
  ~
  ~ This file is part of Cora.
  ~
  ~     Cora is free software: you can redistribute it and/or modify
  ~     it under the terms of the GNU General Public License as published by
  ~     the Free Software Foundation, either version 3 of the License, or
  ~     (at your option) any later version.
  ~
  ~     Cora is distributed in the hope that it will be useful,
  ~     but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~     GNU General Public License for more details.
  ~
  ~     You should have received a copy of the GNU General Public License
  ~     along with Cora.  If not, see <http://www.gnu.org/licenses/>.
  -->

<html>
<head>
<meta charset="UTF-8"></meta>
<title>JSClient</title>
<link rel="stylesheet" type="text/css" href="css/presentation.css"></link>
<link rel="stylesheet" type="text/css" href="css/jsClient.css"></link>
<link rel="stylesheet" type="text/css" href="css/message.css"></link>
<link rel="stylesheet" type="text/css" href="css/busy.css"></link>
<link rel="stylesheet" type="text/css" href="css/question.css"></link>


<script type="text/javascript" src="script/aCoraNameSpace.js"></script>
<script type="text/javascript" src="script/coraPubSub.js"></script>
<script type="text/javascript" src="script/jsClient.js"></script>
<script type="text/javascript" src="script/jsClientView.js"></script>
<script type="text/javascript" src="script/jsClientViewFactory.js"></script>
<script type="text/javascript" src="script/managedGuiItem.js"></script>
<script type="text/javascript" src="script/managedGuiItemView.js"></script>
<script type="text/javascript" src="script/managedGuiItemFactory.js"></script>
<script type="text/javascript" src="script/managedGuiItemViewFactory.js"></script>
<script type="text/javascript" src="script/recordGuiFactory.js"></script>
<script type="text/javascript" src="script/recordHandler.js"></script>
<script type="text/javascript" src="script/recordHandlerFactory.js"></script>
<script type="text/javascript" src="script/recordHandlerView.js"></script>
<script type="text/javascript" src="script/recordHandlerViewFactory.js"></script>
<script type="text/javascript" src="script/recordListHandler.js"></script>
<script type="text/javascript" src="script/recordListHandlerFactory.js"></script>
<script type="text/javascript" src="script/recordTypeHandler.js"></script>
<script type="text/javascript" src="script/recordTypeHandlerView.js"></script>
<script type="text/javascript" src="script/recordTypeHandlerViewFactory.js"></script>
<script type="text/javascript" src="script/recordTypeProvider.js"></script>
<script type="text/javascript" src="script/recordViewer.js"></script>

<script type="text/javascript" src="script/search/searchHandler.js"></script>
<script type="text/javascript" src="script/search/searchHandlerFactory.js"></script>
<script type="text/javascript" src="script/search/searchHandlerView.js"></script>
<script type="text/javascript" src="script/search/searchHandlerViewFactory.js"></script>
<script type="text/javascript" src="script/search/searchRecordHandlerFactory.js"></script>
<script type="text/javascript" src="script/search/searchRecordHandler.js"></script>
<script type="text/javascript" src="script/search/searchRecordHandlerViewFactory.js"></script>
<script type="text/javascript" src="script/search/searchRecordHandlerView.js"></script>
<script type="text/javascript" src="script/search/searchProvider.js"></script>

<script type="text/javascript" src="script/gui/basicGui.js"></script>
<script type="text/javascript" src="script/gui/busy.js"></script>
<script type="text/javascript" src="script/gui/holder.js"></script>
<script type="text/javascript" src="script/gui/holderFactory.js"></script>
<script type="text/javascript" src="script/gui/info.js"></script>
<script type="text/javascript" src="script/gui/infoFactory.js"></script>
<script type="text/javascript" src="script/gui/message.js"></script>
<script type="text/javascript" src="script/gui/messageHolder.js"></script>
<script type="text/javascript" src="script/gui/messageHolderFactory.js"></script>
<script type="text/javascript" src="script/gui/question.js"></script>
<script type="text/javascript" src="script/gui/workItemView.js"></script>
<script type="text/javascript" src="script/gui/workItemViewFactory.js"></script>

<script type="text/javascript" src="script/lib/arbiter.js"></script>
<script type="text/javascript" src="script/lib/polyfillES6.js"></script>

<script type="text/javascript" src="script/login/authTokenHolder.js"></script>
<script type="text/javascript" src="script/login/loginManager.js"></script>
<script type="text/javascript" src="script/login/loginManagerView.js"></script>
<script type="text/javascript" src="script/login/loginManagerFactory.js"></script>
<script type="text/javascript" src="script/login/loginManagerViewFactory.js"></script>
<script type="text/javascript" src="script/login/appTokenLogin.js"></script>
<script type="text/javascript" src="script/login/appTokenLoginFactory.js"></script>

<script type="text/javascript" src="script/metadata/calculatePathForNewElement.js"></script>
<script type="text/javascript" src="script/metadata/coraData.js"></script>
<script type="text/javascript" src="script/metadata/dataHolder.js"></script>
<script type="text/javascript" src="script/metadata/jsBookkeeper.js"></script>
<script type="text/javascript" src="script/metadata/metadataChildInitializer.js"></script>
<script type="text/javascript" src="script/metadata/metadataChildValidator.js"></script>
<script type="text/javascript" src="script/metadata/metadataController.js"></script>
<script type="text/javascript" src="script/metadata/metadataHelper.js"></script>
<script type="text/javascript" src="script/metadata/metadataProvider.js"></script>
<script type="text/javascript" src="script/metadata/metadataRepeatInitializer.js"></script>
<script type="text/javascript" src="script/metadata/metadataRepeatValidator.js"></script>
<script type="text/javascript" src="script/metadata/metadataValidator.js"></script>
<script type="text/javascript" src="script/metadata/textProvider.js"></script>

<script type="text/javascript" src="script/net/ajaxCall.js"></script>
<script type="text/javascript" src="script/net/ajaxCallFactory.js"></script>
<script type="text/javascript" src="script/net/uploadManager.js"></script>
<script type="text/javascript" src="script/net/uploadManagerView.js"></script>
<script type="text/javascript" src="script/net/xmlHttpRequestFactory.js"></script>

<script type="text/javascript" src="script/presentation/pChildRefHandler.js"></script>
<script type="text/javascript" src="script/presentation/pChildRefHandlerFactory.js"></script>
<script type="text/javascript" src="script/presentation/pChildRefHandlerView.js"></script>
<script type="text/javascript" src="script/presentation/pChildRefHandlerViewFactory.js"></script>
<script type="text/javascript" src="script/presentation/pCollectionVar.js"></script>
<script type="text/javascript" src="script/presentation/pGroup.js"></script>
<script type="text/javascript" src="script/presentation/pMultipleChildren.js"></script>
<script type="text/javascript" src="script/presentation/pRecordLink.js"></script>
<script type="text/javascript" src="script/presentation/pRecordLinkFactory.js"></script>
<script type="text/javascript" src="script/presentation/pRecordLinkView.js"></script>
<script type="text/javascript" src="script/presentation/pRecordLinkViewFactory.js"></script>
<script type="text/javascript" src="script/presentation/pRepeatingContainer.js"></script>
<script type="text/javascript" src="script/presentation/pRepeatingElement.js"></script>
<script type="text/javascript" src="script/presentation/pRepeatingElementFactory.js"></script>
<script type="text/javascript" src="script/presentation/pResourceLink.js"></script>
<script type="text/javascript" src="script/presentation/presentation.js"></script>
<script type="text/javascript" src="script/presentation/presentationFactory.js"></script>
<script type="text/javascript" src="script/presentation/pSurroundingContainer.js"></script>
<script type="text/javascript" src="script/presentation/pVar.js"></script>
<script type="text/javascript" src="script/presentation/pVarView.js"></script>
<script type="text/javascript" src="script/presentation/pVarViewFactory.js"></script>

<script type="text/javascript">
	var baseUrl = "http://epc.ub.uu.se/cora/rest/";
	var appTokenBaseUrl = "http://epc.ub.uu.se/";
	window.onload = start;
	var jsClientSpec;
	var jsClientDependencies;

	function start() {
		askForServerToUse();
	}
	
	function askForServerToUse() {
		var questionSpec = {
			"text" : "Vilket server vill du anv√§nda?",
			"buttons" : [ {
				"text" : "Uppsala Universitetsbibliotek",
				"onclickFunction" : useUb
			}, {
				"text" : "localhost",
				"onclickFunction" : useLocalhost
			} ]
		};
		var question = CORA.question(questionSpec);
		var questionView = question.getView();
		document.body.appendChild(questionView);
	}

	function useUb() {
		baseUrl = "http://epc.ub.uu.se/cora/rest/";
		appTokenBaseUrl = "http://epc.ub.uu.se/";
		startDependencies();
	}

	function useLocalhost() {
		appTokenBaseUrl = "http://localhost:8080/";
		baseUrl = "http://localhost:8080/therest/rest/";
		startDependencies();
	}

	var metadataProviderStarted = false;
	function metadataProviderReady() {
		metadataProviderStarted = true;
		possiblyStartJsClient();
	}

	var textProviderStarted = false;
	function textProviderReady() {
		textProviderStarted = true;
		possiblyStartJsClient();
	}

	var searchProviderStarted = false;
	function searchProviderReady() {
		searchProviderStarted = true;
		possiblyStartJsClient();
	}

	var recordTypeProviderStarted = false;
	function recordTypeProviderReady() {
		recordTypeProviderStarted = true;
		possiblyStartJsClient();
	}

	function possiblyStartJsClient() {
		if (recordTypeProviderStarted && metadataProviderStarted && textProviderStarted
				&& searchProviderStarted) {
			startJsClient();
		}
	}

	function startDependencies() {
		var authTokenHolder = CORA.authTokenHolder();
		var xmlHttpRequestFactory = CORA.xmlHttpRequestFactory();

		//TODO: use this if you want to be logged in at startup:
		// 		authTokenHolder.setCurrentAuthToken("fitnesseAdminToken");

		var ajaxCallFactoryDependencies = {
			"xmlHttpRequestFactory" : xmlHttpRequestFactory,
			"authTokenHolder" : authTokenHolder
		};
		var ajaxCallFactory = CORA.ajaxCallFactory(ajaxCallFactoryDependencies);

		var dependencies = {
			"ajaxCallFactory" : CORA.ajaxCallFactory(ajaxCallFactoryDependencies),
			"authTokenHolder" : authTokenHolder
		};
		var metadataListLink = {
			"requestMethod" : "GET",
			"rel" : "list",
			"url" : baseUrl + "record/metadata/",
			"accept" : "application/uub+recordList+json"
		};
		var presentationListLink = {
			"requestMethod" : "GET",
			"rel" : "list",
			"url" : baseUrl + "record/presentation/",
			"accept" : "application/uub+recordList+json"
		};
		var textListLink = {
			"requestMethod" : "GET",
			"rel" : "list",
			"url" : baseUrl + "record/text/",
			"accept" : "application/uub+recordList+json"
		};
		var metadataProviderSpec = {
			"dependencies" : dependencies,
			"metadataListLink" : metadataListLink,
			"textListLink" : textListLink,
			"presentationListLink" : presentationListLink,
			"callWhenReady" : metadataProviderReady
		};

		var metadataProvider = CORA.metadataProvider(metadataProviderSpec);

		var textProviderSpec = {
			"dependencies" : dependencies,
			"textListLink" : textListLink,
			"lang" : "sv",
			"callWhenReady" : textProviderReady
		};

		var textProvider = CORA.textProvider(textProviderSpec);

		var appTokenLoginFactoryDependencies = {
			"ajaxCallFactory" : ajaxCallFactory,
		};
		var appTokenLoginFactory = CORA.appTokenLoginFactory(appTokenLoginFactoryDependencies);

		var loginManagerFactoryDependencies = {
			"authTokenHolder" : authTokenHolder,
			"textProvider" : textProvider,
			"appTokenLoginFactory" : appTokenLoginFactory,
			"ajaxCallFactory" : ajaxCallFactory
		};
		var loginManagerFactory = CORA.loginManagerFactory(loginManagerFactoryDependencies);

		var dependenciesSearchProvider = {
			"ajaxCallFactory" : ajaxCallFactory
		};
		var searchRecordListLink = {
			"requestMethod" : "GET",
			"rel" : "list",
			"url" : baseUrl + "record/search/",
			"accept" : "application/uub+recordList+json"
		};
		var specSearchProvider = {
			"searchRecordListLink" : searchRecordListLink,
			"callWhenReady" : searchProviderReady
		};
		var searchProvider = CORA.searchProvider(dependenciesSearchProvider, specSearchProvider);

		var recordTypeListLink = {
			"requestMethod" : "GET",
			"rel" : "list",
			"url" : baseUrl + "record/recordType/",
			"accept" : "application/uub+recordList+json"
		};
		var recordTypeProviderSpec = {
			"recordTypeListLink" : recordTypeListLink,
			"callWhenReady" : recordTypeProviderReady
		};
		var recordTypeProvider = CORA.recordTypeProvider(dependencies, recordTypeProviderSpec);

		var searchRecordHandlerFactoryDep = {
			"searchRecordHandlerViewFactory" : CORA.searchRecordHandlerViewFactory({}),
			"textProvider" : textProvider,
			"ajaxCallFactory" : ajaxCallFactory
		};
		jsClientDependencies = {
			"ajaxCallFactory" : ajaxCallFactory,
			"authTokenHolder" : authTokenHolder,
			"loginManagerFactory" : loginManagerFactory,
			"metadataProvider" : metadataProvider,
			"textProvider" : textProvider,
			"searchProvider" : searchProvider,
			"recordTypeProvider" : recordTypeProvider,
			"xmlHttpRequestFactory" : CORA.xmlHttpRequestFactory(),
			"jsClientViewFactory" : CORA.jsClientViewFactory(),
			"searchRecordHandlerFactory" : CORA
					.searchRecordHandlerFactory(searchRecordHandlerFactoryDep),
			"presentationFactoryFactory" : "not implemented yet"
		}
		jsClientSpec = {
			"name" : "The Client",
			"baseUrl" : baseUrl,
			"appTokenBaseUrl" : appTokenBaseUrl
		};
	}

	function startJsClient() {
		var jsClient = CORA.jsClient(jsClientDependencies, jsClientSpec);
		document.body.appendChild(jsClient.getView());
	}

	function callError(error) {
		console.log(error);
	}

	function callAfterAnswer() {
	}
</script>
</head>
<body>

</body>
</html>

