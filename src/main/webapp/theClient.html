<!DOCTYPE html>
<!--
  ~ Copyright 2016, 2017 Olov McKie
  ~ Copyright 2016, 2017, 2018, 2019, 2020 Uppsala University Library
  ~
  ~ This file is part of Cora.
  ~
  ~     Cora is free software: you can redistribute it and/or modify
  ~     it under the terms of the GNU General Public License as published by
  ~     the Free Software Foundation, either version 3 of the License, or
  ~     (at your option) any later version.
  ~
  ~     Cora is distributed in the hope that it will be useful,
  ~     but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~     GNU General Public License for more details.
  ~
  ~     You should have received a copy of the GNU General Public License
  ~     along with Cora.  If not, see <http://www.gnu.org/licenses/>.
  -->

<html>
<head>
<meta charset="UTF-8"></meta>
<title>JSClient</title>
<link rel="icon" type="image/svg+xml" href="images/coraIcon.svg" id="tabIcon">

<link rel="stylesheet" type="text/css" href="css/loading.css"></link>
<link rel="stylesheet" type="text/css" href="css/presentation.css"></link>
<link rel="stylesheet" type="text/css" href="css/jsClient.css"></link>
<link rel="stylesheet" type="text/css" href="css/message.css"></link>
<link rel="stylesheet" type="text/css" href="css/busy.css"></link>
<link rel="stylesheet" type="text/css" href="css/question.css"></link>
<link rel="stylesheet" type="text/css" href="css/lib/leaflet.css"></link>
<link rel="stylesheet" type="text/css" href="css/lib/minimap.css"></link>

<link href="css/default.css" rel="stylesheet" type="text/css" title="A Client" id="aClientCSS">
<link href="css/systemOne.css" rel="alternate stylesheet" type="text/css" title="System One"
	id="systemOneCSS">
<link href="css/alvin.css" rel="alternate stylesheet" type="text/css" title="Alvin" id="alvinCSS">
<link href="css/diva.css" rel="alternate stylesheet" type="text/css" title="DiVA" id="divaCSS">
<link href="css/diva-lila.css" rel="alternate stylesheet" type="text/css" title="DiVA-lila"
	id="divaLilaCSS">
<link href="css/student-1.css" rel="alternate stylesheet" type="text/css" title="Student 1"
	id="student1CSS">
<link href="css/student-2.css" rel="alternate stylesheet" type="text/css" title="Student 2"
	id="student2CSS">
<link href="css/student-3.css" rel="alternate stylesheet" type="text/css" title="Student 3"
	id="student3CSS">

<script type="text/javascript" src="script/aCoraNameSpace.js"></script>
<script type="text/javascript" src="script/pubSub.js"></script>
<script type="text/javascript" src="script/genericFactory.js"></script>
<script type="text/javascript" src="script/genericParentFactory.js"></script>
<script type="text/javascript" src="script/incomingLinksListHandler.js"></script>
<script type="text/javascript" src="script/incomingLinksListHandlerView.js"></script>
<script type="text/javascript" src="script/indexHandler.js"></script>
<script type="text/javascript" src="script/indexListHandler.js"></script>
<script type="text/javascript" src="script/indexListHandlerFactory.js"></script>

<script type="text/javascript" src="script/definitionViewer/definitionViewer.js"></script>
<script type="text/javascript" src="script/definitionViewer/definitionViewerFactory.js"></script>
<script type="text/javascript" src="script/definitionViewer/definitionViewerView.js"></script>
<script type="text/javascript" src="script/definitionViewer/definitionViewerViewFactory.js"></script>
<script type="text/javascript" src="script/definitionViewer/definitionViewerText.js"></script>
<script type="text/javascript" src="script/definitionViewer/definitionViewerTextFactory.js"></script>

<script type="text/javascript" src="script/recursiveDelete/recursiveDelete.js"></script>
<script type="text/javascript" src="script/recursiveDelete/recursiveDeleteFactory.js"></script>
<script type="text/javascript" src="script/recursiveDelete/recursiveDeleteView.js"></script>
<script type="text/javascript" src="script/recursiveDelete/recursiveDeleteDeleter.js"></script>

<script type="text/javascript" src="script/jsClient/clientInstanceProvider.js"></script>
<script type="text/javascript" src="script/jsClient/jsClient.js"></script>
<script type="text/javascript" src="script/jsClient/jsClientFactory.js"></script>
<script type="text/javascript" src="script/jsClient/jsClientView.js"></script>
<script type="text/javascript" src="script/jsClient/jsClientViewFactory.js"></script>
<script type="text/javascript" src="script/jsClient/openGuiItemHandler.js"></script>
<script type="text/javascript" src="script/jsClient/openGuiItemHandlerView.js"></script>
<script type="text/javascript" src="script/jsClient/openGuiItemHandlerFactory.js"></script>
<script type="text/javascript" src="script/jsClient/openGuiItemHandlerViewFactory.js"></script>
<script type="text/javascript" src="script/jsClient/recordTypeMenu.js"></script>

<script type="text/javascript" src="script/managedGuiItem.js"></script>
<script type="text/javascript" src="script/managedGuiItemView.js"></script>
<script type="text/javascript" src="script/managedGuiItemFactory.js"></script>
<script type="text/javascript" src="script/managedGuiItemViewFactory.js"></script>
<script type="text/javascript" src="script/recordHandler.js"></script>
<script type="text/javascript" src="script/recordHandlerFactory.js"></script>
<script type="text/javascript" src="script/recordHandlerView.js"></script>
<script type="text/javascript" src="script/recordHandlerViewFactory.js"></script>
<script type="text/javascript" src="script/recordListHandler.js"></script>
<script type="text/javascript" src="script/recordListHandlerFactory.js"></script>
<script type="text/javascript" src="script/recordPartPermissionCalculator.js"></script>
<script type="text/javascript" src="script/recordTypeHandler.js"></script>
<script type="text/javascript" src="script/recordTypeHandlerFactory.js"></script>
<script type="text/javascript" src="script/recordTypeHandlerView.js"></script>
<script type="text/javascript" src="script/recordTypeHandlerViewFactory.js"></script>
<script type="text/javascript" src="script/recordTypeProvider.js"></script>
<script type="text/javascript" src="script/recordTypeProviderFactory.js"></script>
<script type="text/javascript" src="script/recordTypeSorter.js"></script>
<script type="text/javascript" src="script/reloadableRecordTypeProvider.js"></script>
<script type="text/javascript" src="script/recordViewer.js"></script>

<script type="text/javascript" src="script/search/resultHandler.js"></script>
<script type="text/javascript" src="script/search/resultHandlerFactory.js"></script>
<script type="text/javascript" src="script/search/resultHandlerView.js"></script>
<script type="text/javascript" src="script/search/resultHandlerViewFactory.js"></script>
<script type="text/javascript" src="script/search/searchHandler.js"></script>
<script type="text/javascript" src="script/search/searchHandlerFactory.js"></script>
<script type="text/javascript" src="script/search/searchHandlerView.js"></script>
<script type="text/javascript" src="script/search/searchHandlerViewFactory.js"></script>
<script type="text/javascript" src="script/search/searchHandlerJsClientIntegrator.js"></script>
<script type="text/javascript" src="script/search/searchHandlerJsClientIntegratorFactory.js"></script>
<script type="text/javascript" src="script/search/searchRecordHandlerFactory.js"></script>
<script type="text/javascript" src="script/search/searchRecordHandler.js"></script>
<script type="text/javascript" src="script/search/searchRecordHandlerViewFactory.js"></script>
<script type="text/javascript" src="script/search/searchRecordHandlerView.js"></script>
<script type="text/javascript" src="script/search/searchProvider.js"></script>
<script type="text/javascript" src="script/search/searchProviderFactory.js"></script>
<script type="text/javascript" src="script/search/reloadableSearchProvider.js"></script>

<script type="text/javascript" src="script/gui/basicGui.js"></script>
<script type="text/javascript" src="script/gui/box.js"></script>
<script type="text/javascript" src="script/gui/busy.js"></script>
<script type="text/javascript" src="script/gui/button.js"></script>
<script type="text/javascript" src="script/gui/holder.js"></script>
<script type="text/javascript" src="script/gui/holderFactory.js"></script>
<script type="text/javascript" src="script/gui/info.js"></script>
<script type="text/javascript" src="script/gui/inputButton.js"></script>
<script type="text/javascript" src="script/gui/infoFactory.js"></script>
<script type="text/javascript" src="script/gui/message.js"></script>
<script type="text/javascript" src="script/gui/messageHolder.js"></script>
<script type="text/javascript" src="script/gui/messageHolderFactory.js"></script>
<script type="text/javascript" src="script/gui/question.js"></script>
<script type="text/javascript" src="script/gui/workItemView.js"></script>
<script type="text/javascript" src="script/gui/workItemViewFactory.js"></script>

<script type="text/javascript" src="script/lib/arbiter.js"></script>
<script type="text/javascript" src="script/lib/polyfillES6.js"></script>
<script type="text/javascript" src="script/lib/leaflet.js"></script>
<script type="text/javascript" src="script/lib/minimap.js"></script>

<script type="text/javascript" src="script/login/authTokenHolder.js"></script>
<script type="text/javascript" src="script/login/loginManager.js"></script>
<script type="text/javascript" src="script/login/loginManagerView.js"></script>
<script type="text/javascript" src="script/login/loginManagerFactory.js"></script>
<script type="text/javascript" src="script/login/loginManagerViewFactory.js"></script>
<script type="text/javascript" src="script/login/appTokenLogin.js"></script>
<script type="text/javascript" src="script/login/appTokenLoginFactory.js"></script>
<script type="text/javascript" src="script/login/webRedirectLogin.js"></script>
<script type="text/javascript" src="script/login/webRedirectLoginFactory.js"></script>
<script type="text/javascript" src="script/login/passwordLogin.js"></script>
<script type="text/javascript" src="script/login/passwordLoginFactory.js"></script>
<script type="text/javascript" src="script/login/passwordLoginJsClientIntegrator.js"></script>
<script type="text/javascript" src="script/login/passwordLoginView.js"></script>
<script type="text/javascript" src="script/login/passwordLoginViewFactory.js"></script>

<script type="text/javascript" src="script/metadata/calculatePathForNewElement.js"></script>
<script type="text/javascript" src="script/metadata/coraData.js"></script>
<script type="text/javascript" src="script/metadata/dataHolder.js"></script>
<script type="text/javascript" src="script/metadata/jsBookkeeper.js"></script>
<script type="text/javascript" src="script/metadata/metadataChildInitializer.js"></script>
<script type="text/javascript" src="script/metadata/metadataChildValidator.js"></script>
<script type="text/javascript" src="script/metadata/metadataChildAndRepeatInitializerFactory.js"></script>
<script type="text/javascript" src="script/metadata/metadataController.js"></script>
<script type="text/javascript" src="script/metadata/metadataControllerFactory.js"></script>
<script type="text/javascript" src="script/metadata/metadataHelper.js"></script>
<script type="text/javascript" src="script/metadata/metadataProvider.js"></script>
<script type="text/javascript" src="script/metadata/metadataRepeatInitializer.js"></script>
<script type="text/javascript" src="script/metadata/metadataRepeatValidator.js"></script>
<script type="text/javascript" src="script/metadata/metadataValidator.js"></script>
<script type="text/javascript" src="script/metadata/metadataValidatorFactory.js"></script>
<script type="text/javascript" src="script/metadata/textProvider.js"></script>
<script type="text/javascript" src="script/metadata/textProviderFactory.js"></script>
<script type="text/javascript" src="script/metadata/reloadableTextProvider.js"></script>
<script type="text/javascript" src="script/metadata/reloadableMetadataProvider.js"></script>
<script type="text/javascript" src="script/metadata/metadataProviderFactory.js"></script>
<script type="text/javascript" src="script/metadata/numberVariableValidator.js"></script>
<script type="text/javascript" src="script/metadata/pathUtils.js"></script>

<script type="text/javascript" src="script/net/ajaxCall.js"></script>
<script type="text/javascript" src="script/net/ajaxCallFactory.js"></script>
<script type="text/javascript" src="script/net/uploadManager.js"></script>
<script type="text/javascript" src="script/net/uploadManagerFactory.js"></script>
<script type="text/javascript" src="script/net/uploadManagerView.js"></script>
<script type="text/javascript" src="script/net/xmlHttpRequestFactory.js"></script>

<script type="text/javascript" src="script/presentation/pChildRefHandler.js"></script>
<script type="text/javascript" src="script/presentation/pChildRefHandlerView.js"></script>
<script type="text/javascript" src="script/presentation/pCollectionVar.js"></script>
<script type="text/javascript" src="script/presentation/pCollectionVarView.js"></script>
<script type="text/javascript" src="script/presentation/pGroup.js"></script>
<script type="text/javascript" src="script/presentation/pGroupView.js"></script>
<script type="text/javascript" src="script/presentation/pMultipleChildrenViewFactory.js"></script>
<script type="text/javascript" src="script/presentation/pParentMultipleChildren.js"></script>
<script type="text/javascript" src="script/presentation/pParentMultipleChildrenView.js"></script>
<script type="text/javascript" src="script/presentation/pParentVar.js"></script>
<script type="text/javascript" src="script/presentation/pParentVarView.js"></script>
<script type="text/javascript" src="script/presentation/pRecordLink.js"></script>
<script type="text/javascript" src="script/presentation/pRecordLinkView.js"></script>
<script type="text/javascript" src="script/presentation/pRepeatingContainer.js"></script>
<script type="text/javascript" src="script/presentation/pRepeatingElement.js"></script>
<script type="text/javascript" src="script/presentation/pResourceLink.js"></script>
<script type="text/javascript" src="script/presentation/pResourceLinkView.js"></script>
<script type="text/javascript" src="script/presentation/presentationFactory.js"></script>
<script type="text/javascript" src="script/presentation/presentationHolder.js"></script>
<script type="text/javascript" src="script/presentation/presentationHolderFactory.js"></script>
<script type="text/javascript" src="script/presentation/pMap.js"></script>
<script type="text/javascript" src="script/presentation/pMapView.js"></script>
<script type="text/javascript" src="script/presentation/pNonRepeatingChildRefHandler.js"></script>
<script type="text/javascript" src="script/presentation/pNonRepeatingChildRefHandlerView.js"></script>
<script type="text/javascript" src="script/presentation/pSurroundingContainer.js"></script>
<script type="text/javascript" src="script/presentation/pSurroundingContainerView.js"></script>
<script type="text/javascript" src="script/presentation/pVar.js"></script>
<script type="text/javascript" src="script/presentation/pVarView.js"></script>
<script type="text/javascript" src="script/presentation/pVarViewFactory.js"></script>
<script type="text/javascript" src="script/presentation/pNumVar.js"></script>
<script type="text/javascript" src="script/presentation/pNumVarView.js"></script>
<script type="text/javascript" src="script/presentation/pAttributes.js"></script>
<script type="text/javascript" src="script/presentation/pAttributesView.js"></script>

<script type="text/javascript" src="script/recordGui/recordGui.js"></script>
<script type="text/javascript" src="script/recordGui/recordGuiFactory.js"></script>

<script type="text/javascript" src="serverRestUrl.jsp"></script>
<script type="text/javascript" src="useServer.js"></script>


<script type="text/javascript">
	window.onload = start;

	let name = "A Client";
	let baseUrl = "http://epc.ub.uu.se/cora/rest/";
	let appTokenLogin;
	let passwordLogin;
	let jsClientSpec;
	let jsClientDependencies;
	let jsClient;
	let jsClientView;
	let authTokenHolder;
	let xmlHttpRequestFactory;
	let ajaxCallFactory;
	let metadataProvider;
	let textProvider;
	let searchProvider;
	let recordTypeProvider;
	let uploadManager;
	
	authTokenHolder = CORA.authTokenHolder();
	xmlHttpRequestFactory = CORA.xmlHttpRequestFactory();

	let ajaxCallFactoryDependencies = {
		"xmlHttpRequestFactory" : xmlHttpRequestFactory,
		"authTokenHolder" : authTokenHolder
	};
	ajaxCallFactory = CORA.ajaxCallFactory(ajaxCallFactoryDependencies);
	
	let metadataProviderStarted = false;
	function metadataProviderReady() {
		metadataProviderStarted = true;
		possiblyStartJsClient();
	}

	let textProviderStarted = false;
	function textProviderReady() {
		textProviderStarted = true;
		possiblyStartJsClient();
	}

	let searchProviderStarted = false;
	function searchProviderReady() {
		searchProviderStarted = true;
		possiblyStartJsClient();
	}

	let recordTypeProviderStarted = false;
	function recordTypeProviderReady() {
		recordTypeProviderStarted = true;
		possiblyStartJsClient();
	}

	function possiblyStartJsClient() {
		if (recordTypeProviderStarted && metadataProviderStarted && textProviderStarted
				&& searchProviderStarted) {
			startJsClient();
		}
	}
	
	function startDependencies() {
		tryToPreventAccidentialLeavOfPage();

		let metadataListLink = createListActionLink("metadata");
		let validationTypeListLink = createListActionLink("validationType");
		let presentationListLink = createListActionLink("presentation");
		let textListLink = createListActionLink("text");
		let guiElementListLink = createListActionLink("guiElement");

		let textProviderSpec = {
			"textListLink" : textListLink,
			"lang" : "sv",
			"callWhenReady" : textProviderReady
		};
		let dependenciesTextProviderFactory = {
			"ajaxCallFactory" : ajaxCallFactory
		};
		let dependenciesTextProvider = {
			"textProviderFactory" : CORA.textProviderFactory(dependenciesTextProviderFactory)
		};
		textProvider = CORA.reloadableTextProvider(dependenciesTextProvider, textProviderSpec);

		let metadataProviderSpec = {
			"metadataListLink" : metadataListLink,
			"textListLink" : textListLink,
			"presentationListLink" : presentationListLink,
			"guiElementListLink" : guiElementListLink,
			"callWhenReady" : metadataProviderReady
		};

		let dependenciesMetadataProviderFactory = {
			"textProvider" : textProvider,
			"ajaxCallFactory" : ajaxCallFactory
		};
		let dependenciesMetadataProvider = {
			"metadataProviderFactory" : CORA
					.metadataProviderFactory(dependenciesMetadataProviderFactory)
		};
		metadataProvider = CORA.reloadableMetadataProvider(dependenciesMetadataProvider,
				metadataProviderSpec);

		let dependenciesSearchProviderFactory = {
			"ajaxCallFactory" : ajaxCallFactory
		};

		let dependenciesSearchProvider = {
			"searchProviderFactory" : CORA.searchProviderFactory(dependenciesSearchProviderFactory)
		};

		let searchRecordListLink = createListActionLink("search");
		let specSearchProvider = {
			"searchRecordListLink" : searchRecordListLink,
			"callWhenReady" : searchProviderReady
		};
		searchProvider = CORA.reloadableSearchProvider(dependenciesSearchProvider,
				specSearchProvider);

		let dependenciesRecordTypeProviderFactory = {
			"ajaxCallFactory" : ajaxCallFactory
		};
		let dependenciesReloadableRecordTypeProvider = {
			"recordTypeProviderFactory" : CORA
					.recordTypeProviderFactory(dependenciesRecordTypeProviderFactory)
		};
		
		let recordTypeListLink = createListActionLink("recordType");
		let recordTypeProviderSpec = {
			"recordTypeListLink" : recordTypeListLink,
			"validationTypeListLink" : validationTypeListLink,
			"callWhenReady" : recordTypeProviderReady
		};
		recordTypeProvider = CORA.reloadableRecordTypeProvider(
				dependenciesReloadableRecordTypeProvider, recordTypeProviderSpec);
	}
	
	function tryToPreventAccidentialLeavOfPage() {
		window.addEventListener("beforeunload", function(e) {
			let confirmationMessage = "\o/";
			(e || window.event).returnValue = confirmationMessage; //Gecko + IE
			return confirmationMessage; //Webkit, Safari, Chrome etc.
		});

	}
	
	const createListActionLink = function(recordType) {
		return {
			requestMethod : "GET",
			rel : "list",
			url : baseUrl + "record/"+recordType+"/",
			accept : "application/vnd.cora.recordList+json"
		};
	};
	
	function startJsClient() {
		let providers = {
			"metadataProvider" : metadataProvider,
			"textProvider" : textProvider,
			"searchProvider" : searchProvider,
			"recordTypeProvider" : recordTypeProvider,
			"clientInstanceProvider" : CORA.clientInstanceProvider()
		};
		jsClientSpec = {
			"name" : name,
			"baseUrl" : baseUrl,
			appTokenLogin: appTokenLogin,
			passwordLogin: passwordLogin
			
		};
		let dependencies = {
			"authTokenHolder" : authTokenHolder
		};
		let jsClientFactory = CORA.jsClientFactory(providers, dependencies);
		jsClient = jsClientFactory.factor(jsClientSpec);
		jsClientView = jsClient.getView();
		document.body.appendChild(jsClient.getView());
	}

	function callError(error) {
		//console.log(error);
	}

	function callAfterAnswer() {
	}
</script>
</head>

<body>
    <div class="loader">
        <div class="logo-section">
            <div class="logo-icon" id="systemOneLogo">S</div>
            <div class="logo-icon" id="alvinLogo">A</div>
            <div class="logo-icon" id="divaLogo">D</div>    
            <div class="logo-text">
                <div class="logo-title" id="systemOneLoading">SystemOne</div>
                <div class="logo-title" id="alvinLoading">Alvin</div>
                <div class="logo-title" id="divaLoading">DiVA</div>
                <div class="logo-subtitle">Laddar Metadata</div>
                <div class="status-dots">
                    <div class="status-dot"></div>
                    <div class="status-dot"></div>
                    <div class="status-dot"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

